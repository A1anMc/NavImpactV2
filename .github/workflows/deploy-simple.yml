name: ğŸš€ NavImpact Simple Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Job 1: Deploy Backend First
  deploy-backend:
    runs-on: ubuntu-latest
    name: ğŸ”§ Deploy Backend API
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Trigger Backend Deployment
      run: |
        echo "ğŸ”§ Backend deployment triggered via git push"
        echo "ğŸ“Š Monitor at: https://dashboard.render.com"
        echo "â³ Waiting for backend to be ready..."
    
    - name: â³ Wait for backend health
      run: |
        echo "Waiting for backend to be healthy..."
        for i in {1..30}; do
          if curl -f https://navimpact-api.onrender.com/health > /dev/null 2>&1; then
            echo "âœ… Backend is healthy!"
            break
          fi
          echo "â³ Attempt $i/30 - Backend not ready yet..."
          sleep 10
        done
    
    - name: ğŸ”§ Migration Status
      run: |
        echo "ğŸ”§ Migration endpoint available at:"
        echo "POST https://navimpact-api.onrender.com/api/v1/migrations/budget-migration"
        echo "âš ï¸  Requires admin token - run manually if needed"

  # Job 2: Deploy Frontend After Backend
  deploy-frontend:
    runs-on: ubuntu-latest
    name: ğŸŒ Deploy Frontend
    needs: deploy-backend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Trigger Frontend Deployment
      run: |
        echo "ğŸŒ Frontend deployment needs to be triggered manually"
        echo "ğŸ“Š Go to: https://dashboard.render.com"
        echo "ğŸ¯ Find 'navimpact-web' service and click 'Manual Deploy'"
        echo "â³ Or wait for auto-deployment if enabled"
    
    - name: â³ Wait for frontend health
      run: |
        echo "Waiting for frontend to be healthy..."
        for i in {1..30}; do
          if curl -f https://navimpact-web.onrender.com > /dev/null 2>&1; then
            echo "âœ… Frontend is healthy!"
            break
          fi
          echo "â³ Attempt $i/30 - Frontend not ready yet..."
          sleep 10
        done

  # Job 3: Verify Deployment
  verify-deployment:
    runs-on: ubuntu-latest
    name: âœ… Verify Deployment
    needs: [deploy-backend, deploy-frontend]
    
    steps:
    - name: ğŸ” Test Backend API
      run: |
        echo "Testing backend API..."
        curl -f https://navimpact-api.onrender.com/health
        echo "âœ… Backend API is working"
    
    - name: ğŸ” Test Frontend
      run: |
        echo "Testing frontend..."
        curl -f https://navimpact-web.onrender.com
        echo "âœ… Frontend is working"
    
    - name: ğŸ‰ Deployment Complete
      run: |
        echo "ğŸ‰ NavImpact deployment completed successfully!"
        echo "ğŸ“Š Services:"
        echo "  Backend: https://navimpact-api.onrender.com"
        echo "  Frontend: https://navimpact-web.onrender.com"
        echo ""
        echo "ğŸš€ Next steps:"
        echo "  1. Test the application"
        echo "  2. Run migration if needed"
        echo "  3. Monitor for any issues" 