name: ğŸš€ NavImpact Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Job 1: Deploy Backend First
  deploy-backend:
    runs-on: ubuntu-latest
    name: ğŸ”§ Deploy Backend API
    outputs:
      backend-url: ${{ steps.deploy.outputs.backend-url }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Deploy to Render (Backend)
      id: deploy
      uses: johnbeynon/render-deploy@v1.0.0
      with:
        service-id: ${{ secrets.RENDER_BACKEND_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}
        wait-for-success: true
    
    - name: â³ Wait for backend health
      run: |
        echo "Waiting for backend to be healthy..."
        for i in {1..30}; do
          if curl -f https://navimpact-api.onrender.com/health > /dev/null 2>&1; then
            echo "âœ… Backend is healthy!"
            break
          fi
          echo "â³ Attempt $i/30 - Backend not ready yet..."
          sleep 10
        done
    
    - name: ğŸ”§ Trigger migration
      run: |
        echo "ğŸ”§ Migration endpoint available at:"
        echo "POST https://navimpact-api.onrender.com/api/v1/migrations/budget-migration"
        echo "âš ï¸  Requires admin token - run manually if needed"

  # Job 2: Deploy Frontend After Backend
  deploy-frontend:
    runs-on: ubuntu-latest
    name: ğŸŒ Deploy Frontend
    needs: deploy-backend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Deploy to Render (Frontend)
      uses: johnbeynon/render-deploy@v1.0.0
      with:
        service-id: ${{ secrets.RENDER_FRONTEND_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}
        wait-for-success: true
    
    - name: â³ Wait for frontend health
      run: |
        echo "Waiting for frontend to be healthy..."
        for i in {1..30}; do
          if curl -f https://navimpact-web.onrender.com > /dev/null 2>&1; then
            echo "âœ… Frontend is healthy!"
            break
          fi
          echo "â³ Attempt $i/30 - Frontend not ready yet..."
          sleep 10
        done

  # Job 3: Verify Deployment
  verify-deployment:
    runs-on: ubuntu-latest
    name: âœ… Verify Deployment
    needs: [deploy-backend, deploy-frontend]
    
    steps:
    - name: ğŸ” Test Backend API
      run: |
        echo "Testing backend API..."
        curl -f https://navimpact-api.onrender.com/health
        echo "âœ… Backend API is working"
    
    - name: ğŸ” Test Frontend
      run: |
        echo "Testing frontend..."
        curl -f https://navimpact-web.onrender.com
        echo "âœ… Frontend is working"
    
    - name: ğŸ‰ Deployment Complete
      run: |
        echo "ğŸ‰ NavImpact deployment completed successfully!"
        echo "ğŸ“Š Services:"
        echo "  Backend: https://navimpact-api.onrender.com"
        echo "  Frontend: https://navimpact-web.onrender.com" 